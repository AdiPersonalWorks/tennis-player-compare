package dk.tennis.compare.predict
import dk.atp.api.domain.MatchComposite
import dk.tennis.compare.predict.TennisPredict.PredictionRecord
import org.joda.time.DateTime
import java.util.Date
import org.joda.time.Duration
import scala.collection.mutable.ListBuffer
import dk.tennis.dbn.MatchOutcome
import dk.tennis.dbn.GenericTennisDBN

/**
 * Predicts winner of a tennis match based on a dynamic bayesian network rating system.
 *
 * @author korzekwad
 */
object DbnTennisPredict extends TennisPredict {

  // EM Log likelihood for iteration 100 = -4423.835524
  private val priorProb = Array(0.4970, 0.1377, 0.0783, 0.0442, 0.0370, 0.0215, 0.0122, 0.0570, 0.0000, 0.0371, 0.0128, 0.0143, 0.0056, 0.0000, 0.0000, 0.0150, 0.0038, 0.0196, 0.0055, 0.0015)
  private val emissionProb = Array(0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.08317269649392235, 0.9168273035060777, 0.06913842034334682, 0.9308615796566532, 0.05732417589886874, 0.9426758241011313, 0.04742587317756679, 0.9525741268224333, 0.039165722796764356, 0.9608342772032357, 0.0322954646984505, 0.9677045353015495, 0.02659699357686586, 0.9734030064231342, 0.02188127093613047, 0.9781187290638695, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.08317269649392235, 0.9168273035060777, 0.06913842034334682, 0.9308615796566532, 0.05732417589886874, 0.9426758241011313, 0.04742587317756679, 0.9525741268224333, 0.039165722796764356, 0.9608342772032357, 0.0322954646984505, 0.9677045353015495, 0.02659699357686586, 0.9734030064231342, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.08317269649392235, 0.9168273035060777, 0.06913842034334682, 0.9308615796566532, 0.05732417589886874, 0.9426758241011313, 0.04742587317756679, 0.9525741268224333, 0.039165722796764356, 0.9608342772032357, 0.0322954646984505, 0.9677045353015495, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.08317269649392235, 0.9168273035060777, 0.06913842034334682, 0.9308615796566532, 0.05732417589886874, 0.9426758241011313, 0.04742587317756679, 0.9525741268224333, 0.039165722796764356, 0.9608342772032357, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.08317269649392235, 0.9168273035060777, 0.06913842034334682, 0.9308615796566532, 0.05732417589886874, 0.9426758241011313, 0.04742587317756679, 0.9525741268224333, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.08317269649392235, 0.9168273035060777, 0.06913842034334682, 0.9308615796566532, 0.05732417589886874, 0.9426758241011313, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.08317269649392235, 0.9168273035060777, 0.06913842034334682, 0.9308615796566532, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.08317269649392235, 0.9168273035060777, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.09975048911968513, 0.9002495108803149, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.11920292202211757, 0.8807970779778824, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.1418510649004878, 0.8581489350995122, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.16798161486607552, 0.8320183851339245, 0.9168273035060777, 0.08317269649392234, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.19781611144141825, 0.8021838885585817, 0.9308615796566531, 0.06913842034334694, 0.9168273035060777, 0.08317269649392234, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.23147521650098232, 0.7685247834990176, 0.9426758241011313, 0.057324175898868734, 0.9308615796566531, 0.06913842034334694, 0.9168273035060777, 0.08317269649392234, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.2689414213699951, 0.7310585786300049, 0.9525741268224331, 0.04742587317756686, 0.9426758241011313, 0.057324175898868734, 0.9308615796566531, 0.06913842034334694, 0.9168273035060777, 0.08317269649392234, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.31002551887238755, 0.6899744811276125, 0.9608342772032357, 0.039165722796764335, 0.9525741268224331, 0.04742587317756686, 0.9426758241011313, 0.057324175898868734, 0.9308615796566531, 0.06913842034334694, 0.9168273035060777, 0.08317269649392234, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.35434369377420455, 0.6456563062257954, 0.9677045353015495, 0.03229546469845046, 0.9608342772032357, 0.039165722796764335, 0.9525741268224331, 0.04742587317756686, 0.9426758241011313, 0.057324175898868734, 0.9308615796566531, 0.06913842034334694, 0.9168273035060777, 0.08317269649392234, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.401312339887548, 0.598687660112452, 0.973403006423134, 0.026596993576865957, 0.9677045353015495, 0.03229546469845046, 0.9608342772032357, 0.039165722796764335, 0.9525741268224331, 0.04742587317756686, 0.9426758241011313, 0.057324175898868734, 0.9308615796566531, 0.06913842034334694, 0.9168273035060777, 0.08317269649392234, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5, 0.45016600268752216, 0.5498339973124778, 0.9781187290638694, 0.02188127093613057, 0.973403006423134, 0.026596993576865957, 0.9677045353015495, 0.03229546469845046, 0.9608342772032357, 0.039165722796764335, 0.9525741268224331, 0.04742587317756686, 0.9426758241011313, 0.057324175898868734, 0.9308615796566531, 0.06913842034334694, 0.9168273035060777, 0.08317269649392234, 0.9002495108803148, 0.0997504891196852, 0.8807970779778823, 0.11920292202211769, 0.8581489350995123, 0.1418510649004877, 0.8320183851339245, 0.16798161486607555, 0.8021838885585818, 0.1978161114414182, 0.7685247834990175, 0.23147521650098246, 0.7310585786300049, 0.2689414213699951, 0.6899744811276125, 0.3100255188723875, 0.6456563062257954, 0.3543436937742046, 0.598687660112452, 0.401312339887548, 0.549833997312478, 0.45016600268752205, 0.5, 0.5)
  private val transitionProb = Array(0.9640, 0.0097, 0.0004, 0.0111, 0.0000, 0.0065, 0.0061, 0.0000, 0.0013, 0.0000, 0.0009, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0001, 0.9836, 0.0115, 0.0000, 0.0000, 0.0002, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0029, 0.0010, 0.0000, 0.0000, 0.0000, 0.0007, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9653, 0.0000, 0.0111, 0.0000, 0.0037, 0.0000, 0.0118, 0.0000, 0.0000, 0.0061, 0.0000, 0.0000, 0.0004, 0.0000, 0.0016, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9877, 0.0101, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0012, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0010, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9983, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0017, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9894, 0.0068, 0.0000, 0.0037, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0412, 0.0000, 0.9506, 0.0057, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0025, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9835, 0.0000, 0.0000, 0.0000, 0.0000, 0.0075, 0.0021, 0.0070, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0035, 0.0000, 0.0000, 0.0000, 0.9839, 0.0032, 0.0000, 0.0000, 0.0000, 0.0095, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0080, 0.9920, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9808, 0.0000, 0.0000, 0.0000, 0.0070, 0.0065, 0.0000, 0.0057, 0.0000, 0.0000, 0.0197, 0.0000, 0.0000, 0.0000, 0.0000, 0.0068, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9537, 0.0000, 0.0000, 0.0056, 0.0105, 0.0000, 0.0000, 0.0000, 0.0036, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9890, 0.0000, 0.0000, 0.0000, 0.0069, 0.0040, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0095, 0.0000, 0.0000, 0.0000, 0.0000, 0.9693, 0.0000, 0.0142, 0.0069, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0186, 0.0000, 0.9814, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0046, 0.0113, 0.9689, 0.0113, 0.0000, 0.0039, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9840, 0.0126, 0.0000, 0.0034, 0.0000, 0.0000, 0.0000, 0.0000, 0.0039, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9757, 0.0204, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0061, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.9457, 0.0482, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0000, 0.0056, 0.0000, 0.0000, 0.9944)

  def predict(matches: Seq[MatchComposite], matchFilter: (MatchComposite) => Boolean, progress: (PredictionRecord) => Unit): Seq[PredictionRecord] = {

    val matchesSize = matches.size

    val timeSliceInDays = 3000
    val tennisDBN = GenericTennisDBN(priorProb, emissionProb, transitionProb, timeSliceInDays)
    val predictionRecords: ListBuffer[PredictionRecord] = ListBuffer()

    for ((m, index) <- matches.zipWithIndex) {

      val result = toMatchOutcome(m)
      tennisDBN.addMatch(result.copy(playerAWinner = None))

      if (matchFilter(m)) {
        println("Predicting winner of tennis match  (DBN model) - %d / %d".format(index, matchesSize))

        tennisDBN.calibrate()

        val matchProbAGivenB = tennisDBN.getMatchProbability(result.playerA, result.playerB, result.matchTime)
        //   println(result.playerA + ":" + result.playerB + ":" + matchProbAGivenB + ":" + format(tennisDBN.getPlayerRating(result.playerA, result.matchTime)) + ":" + format(tennisDBN.getPlayerRating(result.playerB, result.matchTime)))

        val predictionRecord = PredictionRecord(
          m.tournament.tournamentTime, m.matchFacts.playerAFacts.playerName,
          m.matchFacts.playerBFacts.playerName,
          matchProbAGivenB,
          m.matchFacts.winner.equals(m.matchFacts.playerAFacts.playerName))

        predictionRecords.append(predictionRecord)
        progress(predictionRecord)
      }

      tennisDBN.updateMatch(result)
    }

    predictionRecords.toList.sortWith((a, b) => a.matchTime.getTime < b.matchTime.getTime())
  }

  private def format(values: Array[Double]): String = values.map(v => v.formatted("%.4f")).mkString("[", ",", "]")

  private def toMatchOutcome(m: MatchComposite): MatchOutcome = {

    val playerAName = m.matchFacts.playerAFacts.playerName
    val playerBName = m.matchFacts.playerBFacts.playerName
    val playerAWinner = m.matchFacts.winner.equals(m.matchFacts.playerAFacts.playerName)

    MatchOutcome(playerAName, playerBName, playerAWinner, m.tournament.tournamentTime.getTime)
  }

  private implicit def bool2int(b: Boolean): Byte = if (b) 1 else 0
}